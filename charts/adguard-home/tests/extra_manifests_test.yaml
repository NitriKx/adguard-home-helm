suite: test extra manifests
templates:
  - extra-manifests.yaml
tests:
  - it: should not render extra manifests by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should render single ConfigMap
    set:
      extraManifests:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: test-config
          data:
            key: value
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: test-config
      - equal:
          path: data.key
          value: value

  - it: should render multiple manifests
    set:
      extraManifests:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: test-config-1
          data:
            key1: value1
        - apiVersion: v1
          kind: Secret
          metadata:
            name: test-secret-1
          type: Opaque
          data:
            key2: dmFsdWUy
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        isKind:
          of: ConfigMap
      - documentIndex: 0
        equal:
          path: metadata.name
          value: test-config-1
      - documentIndex: 1
        isKind:
          of: Secret
      - documentIndex: 1
        equal:
          path: metadata.name
          value: test-secret-1

  - it: should render extra manifests with literal values
    set:
      extraManifests:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: my-custom-config
          data:
            key: value
            environment: test
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: my-custom-config
      - equal:
          path: data.key
          value: value
      - equal:
          path: data.environment
          value: test
